app-id: org.openttd.OpenTTD
runtime: org.freedesktop.Platform
runtime-version: '20.08'
sdk: org.freedesktop.Sdk
command: openttd
rename-icon: openttd
rename-desktop-file: openttd.desktop
finish-args:
  - --device=dri
  - --filesystem=home
  - --share=ipc
  - --share=network
  - --socket=pulseaudio
  - --socket=x11
modules:
  - name: fluidsynth
    buildsystem: cmake
    config-opts:
      - -DLIB_INSTALL_DIR:STRING=lib
    cleanup:
      - /bin
      - /include
      - /lib/pkgconfig
      - /share
    sources:
      - type: archive
        url: https://github.com/FluidSynth/fluidsynth/archive/v2.1.8.tar.gz
        sha256: a254efceff5d99f8d658d12d25318317f37307e6df852ec9baeb7da173496967

  - name: opl3-soundfont
    buildsystem: simple
    build-commands:
      - install -D -m 644 -t /app/share/soundfonts OPL-3_FM_128M.sf2
      - ln -s $FLATPAK_DEST/share/soundfonts/{OPL-3_FM_128M,default}.sf2
    sources:
      - type: file
        url: https://github.com/Mindwerks/opl3-soundfont/releases/download/1.0/OPL-3_FM_128M.sf2
        sha256: 39bff96eee3dcfbce9665e3968701b894ca2136c7d0bd580281b2bbf59e80392

  - name: lzo
    config-opts:
      - --enable-shared
      - --disable-static
    cleanup:
      - /include
      - /lib/*.la
      - /lib/pkgconfig
      - /share
    sources:
      - type: archive
        url: http://www.oberhumer.com/opensource/lzo/download/lzo-2.10.tar.gz
        sha256: c0f892943208266f9b6543b3ae308fab6284c5c90e627931446fb49b4221a072

  - name: openttd
    config-opts:
      - -DCMAKE_BUILD_TYPE:STRING=RelWithDebInfo
      - -DCMAKE_INSTALL_BINDIR:STRING=bin
    buildsystem: cmake-ninja
    builddir: true
    post-install:
      - for s in 16 32 48 64 128 256; do install -D -m 644 -t $FLATPAK_DEST/share/icons/hicolor/${s}x${s}/apps ../media/openttd.${s}.png; done
      - install -D -m 644 -t $FLATPAK_DEST/share/icons/hicolor/scalable/apps ../media/openttd.svg
      - install -D -m 644 -t $FLATPAK_DEST/share/metainfo ../org.openttd.OpenTTD.metainfo.xml
    sources:
      - type: archive
        url: https://cdn.openttd.org/openttd-releases/1.11.0/openttd-1.11.0-source.tar.xz
        sha256: 5e65184e07368ba1afa62dbb3e35abaee6c4da6730ff4bc9eb4447d53363c7a8
        x-checker-data:
          type: html
          url: https://www.openttd.org
          version-pattern: 'Latest version: ((?:\d+\.)?(?:\d+\.)?\d+)'
          url-template: https://cdn.openttd.org/openttd-releases/$version/openttd-$version-source.tar.xz
      - type: patch
        path: soundfont-path.patch
      - type: file
        path: org.openttd.OpenTTD.metainfo.xml

  - name: opengfx
    buildsystem: simple
    build-commands:
      - tar -xf opengfx*.tar
      - mkdir -p /app/share/games/openttd/baseset/opengfx
      - cp -r opengfx*/* /app/share/games/openttd/baseset/opengfx
    sources:
      - type: archive
        url: https://cdn.openttd.org/opengfx-releases/0.6.0/opengfx-0.6.0-all.zip
        sha256: d419c0f5f22131de15f66ebefde464df3b34eb10e0645fe218c59cbc26c20774

  - name: openmsx
    buildsystem: simple
    build-commands:
      - mkdir -p /app/share/games/openttd/baseset/openmsx
      - cp -r * /app/share/games/openttd/baseset/openmsx
    sources:
      - type: archive
        url: https://cdn.openttd.org/openmsx-releases/0.3.1/openmsx-0.3.1-all.zip
        sha256: 92e293ae89f13ad679f43185e83fb81fb8cad47fe63f4af3d3d9f955130460f5

  - name: opensfx
    buildsystem: simple
    build-commands:
      - mkdir -p /app/share/games/openttd/baseset/opensfx
      - cp -r * /app/share/games/openttd/baseset/opensfx
    sources:
      - type: archive
        url: https://cdn.openttd.org/opensfx-releases/0.2.3/opensfx-0.2.3-all.zip
        sha256: 6831b651b3dc8b494026f7277989a1d757961b67c17b75d3c2e097451f75af02
