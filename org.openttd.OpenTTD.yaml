app-id: org.openttd.OpenTTD
runtime: org.freedesktop.Platform
runtime-version: '20.08'
sdk: org.freedesktop.Sdk
command: openttd
rename-icon: openttd
rename-desktop-file: openttd.desktop
finish-args:
  - --device=dri
  - --filesystem=home
  - --share=ipc
  - --share=network
  - --socket=pulseaudio
  - --socket=x11
modules:
  - name: icu
    config-opts:
      - CC=gcc
      - CXX=g++
    cleanup:
      - /bin
      - /include
      - /lib/icu
      - /lib/pkgconfig
      - /sbin
      - /share
    sources:
      - type: archive
        url: https://github.com/unicode-org/icu/releases/download/release-68-2/icu4c-68_2-src.tgz
        md5: c21cbdfe31a1e325afe765a16f907d20
      - type: patch
        path: icudata-stdlibs.patch
    subdir: source

  - name: fluidsynth
    buildsystem: cmake
    config-opts:
      - -DLIB_INSTALL_DIR=lib
    cleanup:
      - /bin
      - /include
      - /lib/pkgconfig
      - /share
    sources:
      - type: archive
        url: https://github.com/FluidSynth/fluidsynth/archive/v2.1.5.tar.gz
        sha256: b539b7c65a650b56f01cd60a4e83c6125c217c5a63c0c214ef6274894a677d00

  - name: fluid-soundfont
    buildsystem: simple
    build-commands:
      - install -Dm644 -t /app/share/sounds/sf2 FluidR3_GM.sf2
    sources:
      - type: archive
        url: http://deb.debian.org/debian/pool/main/f/fluid-soundfont/fluid-soundfont_3.1.orig.tar.gz
        sha256: 2621acaa1c78e4abdb24bdd163230cc577e61276936d6aa6e3180582142f0343

  - name: libxdg-basedir
    config-opts:
      - --enable-shared
      - --disable-static
    cleanup:
      - /include
      - /lib/*.la
      - /lib/pkgconfig
      - /share
    sources:
      - type: archive
        url: https://github.com/devnev/libxdg-basedir/archive/libxdg-basedir-1.2.0.tar.gz
        sha256: 1c2b0032a539033313b5be2e48ddd0ae94c84faf21d93956d53562eef4614868

  - name: lzo
    config-opts:
      - --enable-shared
      - --disable-static
    cleanup:
      - /include
      - /lib/*.la
      - /lib/pkgconfig
      - /share
    sources:
      - type: archive
        url: http://www.oberhumer.com/opensource/lzo/download/lzo-2.10.tar.gz
        sha256: c0f892943208266f9b6543b3ae308fab6284c5c90e627931446fb49b4221a072

  - name: openttd
    config-opts:
      - --prefix-dir=/app
      - --binary-dir=/bin
      - --with-liblzo2=/app/lib/liblzo2.so.2
      - --with-fluidsynth=/app/lib/libfluidsynth.so.2
    post-install:
      - install -D -m 644 -t $FLATPAK_DEST/share/metainfo org.openttd.OpenTTD.metainfo.xml
    sources:
      - type: archive
        url: https://cdn.openttd.org/openttd-releases/1.10.3/openttd-1.10.3-source.tar.xz
        sha256: c11601ef547eb1f6d4f9a035bd19e0a760b47872ce7d9b4117aaa45ac377b53b
        x-checker-data:
          type: html
          url: https://www.openttd.org
          version-pattern: 'Latest version: ((?:\d+\.)?(?:\d+\.)?\d+)'
          url-template: https://cdn.openttd.org/openttd-releases/$version/openttd-$version-source.tar.xz
        size: 6815924
      - type: patch
        path: soundfont-path.patch
      - type: file
        path: org.openttd.OpenTTD.metainfo.xml

  - name: opengfx
    buildsystem: simple
    build-commands:
      - tar -xf opengfx*.tar
      - mkdir -p /app/share/games/openttd/baseset/opengfx
      - cp -r opengfx*/* /app/share/games/openttd/baseset/opengfx
    sources:
      - type: archive
        url: https://cdn.openttd.org/opengfx-releases/0.6.0/opengfx-0.6.0-all.zip
        sha256: d419c0f5f22131de15f66ebefde464df3b34eb10e0645fe218c59cbc26c20774

  - name: openmsx
    buildsystem: simple
    build-commands:
      - mkdir -p /app/share/games/openttd/baseset/openmsx
      - cp -r * /app/share/games/openttd/baseset/openmsx
    sources:
      - type: archive
        url: https://cdn.openttd.org/openmsx-releases/0.3.1/openmsx-0.3.1-all.zip
        sha256: 92e293ae89f13ad679f43185e83fb81fb8cad47fe63f4af3d3d9f955130460f5

  - name: opensfx
    buildsystem: simple
    build-commands:
      - mkdir -p /app/share/games/openttd/baseset/opensfx
      - cp -r * /app/share/games/openttd/baseset/opensfx
    sources:
      - type: archive
        url: https://cdn.openttd.org/opensfx-releases/0.2.3/opensfx-0.2.3-all.zip
        sha256: 6831b651b3dc8b494026f7277989a1d757961b67c17b75d3c2e097451f75af02
